(window.webpackJsonp=window.webpackJsonp||[]).push([[0],{18:function(e,t,n){e.exports=n(29)},25:function(e,t,n){},26:function(e,t,n){},27:function(e,t,n){},28:function(e,t,n){},29:function(e,t,n){"use strict";n.r(t);var a=n(0),r=n.n(a),c=n(16),i=n.n(c),o=(n(24),n(25),n(14)),s=n(2),l=n(3),u=n(5),m=n(4),d=n(6),h=n(31),f=n(32),p=n(33),v=n(34),g=n(8),y=(n(26),function(e){function t(){return Object(s.a)(this,t),Object(u.a)(this,Object(m.a)(t).apply(this,arguments))}return Object(d.a)(t,e),Object(l.a)(t,[{key:"render",value:function(){return r.a.createElement("video",{autoPlay:!0,muted:!0,id:this.props.idAttr,className:"video"})}}]),t}(r.a.Component)),b=(n(27),n(13)),w=function(e){function t(){var e,n;Object(s.a)(this,t);for(var a=arguments.length,r=new Array(a),c=0;c<a;c++)r[c]=arguments[c];return(n=Object(u.a)(this,(e=Object(m.a)(t)).call.apply(e,[this].concat(r)))).ws=null,n.user=null,n}return Object(d.a)(t,e),Object(l.a)(t,[{key:"setUser",value:function(e){this.user=e}},{key:"connect",value:function(){var e=this;this.ws=new WebSocket("wss://r12aimxa21.execute-api.eu-west-2.amazonaws.com/Prod"),this.ws.onmessage=function(t){var n=JSON.parse(t.data);switch(n.action){case"registerSuccess":e.emit("register",{result:!0,name:n.payload});break;case"communticate":e.emit("communticate",n.payload);break;default:e.emit("register",{result:!1,name:null})}}}},{key:"send",value:function(e){if(!this.ws)throw new Error("Connection is lost or has not been established yet");this.user&&(e.from=this.user),this.ws.send(JSON.stringify({message:"sendmessage",data:e}))}},{key:"register",value:function(e){this.send({action:"register",payload:e})}},{key:"communicate",value:function(e,t){this.send({action:"communicate",payload:{to:e,message:t}})}}]),t}(b.EventEmitter),C=(n(28),function(e){function t(){return Object(s.a)(this,t),Object(u.a)(this,Object(m.a)(t).apply(this,arguments))}return Object(d.a)(t,e),Object(l.a)(t,[{key:"render",value:function(){return r.a.createElement("div",{className:"message"},r.a.createElement("span",{className:"message__title"},this.props.item.from),r.a.createElement("div",null,this.props.item.message))}}]),t}(r.a.Component)),E=function(e){function t(e){var n;return Object(s.a)(this,t),(n=Object(u.a)(this,Object(m.a)(t).call(this))).serverConnection=e,n.peerUserName=null,n.localVideo=null,n.localStream=null,n.remoteVideo=null,n.peerConnection=null,n.dataChannel=null,n.receiveChannel=null,n.uuid=null,n.peerConnectionConfig={iceServers:[{urls:"stun:stun.stunprotocol.org:3478"},{urls:"stun:stun.l.google.com:19302"}]},n.gotMessageFromServer=function(e){n.peerConnection||n.start();var t,a=n.peerConnection;try{t=JSON.parse(e.message)}catch(c){return}if(t.uuid&&t.uuid!==n.uuid)if(n.peerUserName=e.from,t.sdp){var r=t.sdp;a.setRemoteDescription(new RTCSessionDescription(t.sdp)).then(function(){"offer"===r.type&&a.createAnswer().then(n.createdDescription).catch(n.errorHandler)}).catch(n.errorHandler)}else t.ice&&a.addIceCandidate(new RTCIceCandidate(t.ice)).catch(n.errorHandler)},n.gotIceCandidate=function(e){null!=e.candidate&&n.serverConnection.communicate(n.peerUserName,JSON.stringify({ice:e.candidate,uuid:n.uuid}))},n.createdDescription=function(e){var t=n.peerConnection;if(!t)throw new Error("No peerConnection");t.setLocalDescription(e).then(function(){n.serverConnection.communicate(n.peerUserName,JSON.stringify({sdp:t.localDescription,uuid:n.uuid}))}).catch(n.errorHandler)},n.gotRemoteStream=function(e){if(!n.remoteVideo)throw new Error("No remoteVideo element");n.remoteVideo.srcObject=e.streams[0]},n.getUserMediaSuccess=function(e){if(!n.localVideo)throw new Error("No localVideo element");n.localStream=e,n.localVideo.srcObject=e},n.errorHandler=function(e){console.log(e)},n}return Object(d.a)(t,e),Object(l.a)(t,[{key:"init",value:function(e,t){this.uuid=this.createUUID(),this.localVideo=document.getElementById(e),this.remoteVideo=document.getElementById(t),this.serverConnection.on("communticate",this.gotMessageFromServer);navigator.mediaDevices.getUserMedia?navigator.mediaDevices.getUserMedia({video:!0,audio:!0}).then(this.getUserMediaSuccess).catch(this.errorHandler):alert("Your browser does not support getUserMedia API")}},{key:"start",value:function(e){var t=this,n=void 0!==e;if(!this.localStream)throw new Error("No localStream");var a=new RTCPeerConnection(this.peerConnectionConfig);a.onicecandidate=this.gotIceCandidate,a.ontrack=this.gotRemoteStream;var r=!0,c=!1,i=void 0;try{for(var o,s=this.localStream.getTracks()[Symbol.iterator]();!(r=(o=s.next()).done);r=!0){var l=o.value;a.addTrack(l,this.localStream)}}catch(m){c=!0,i=m}finally{try{r||null==s.return||s.return()}finally{if(c)throw i}}this.peerConnection=a;var u=a.createDataChannel("datachannel");u.onmessage=function(e){var n={from:t.peerUserName,message:e.data};t.emit("communticate",n),console.log("received: "+e.data)},u.onopen=function(){t.dataChannel=u,console.log("datachannel open")},u.onclose=function(){t.dataChannel=null,console.log("datachannel close")},a.ondatachannel=function(e){t.receiveChannel=e.channel,t.receiveChannel.onclose=function(){t.receiveChannel=null},t.receiveChannel.onmessage=function(e){console.log("received: "+e.data);var n={from:t.peerUserName,message:e.data};t.emit("communticate",n)}},n&&(this.peerUserName=e,a.createOffer().then(this.createdDescription).catch(this.errorHandler))}},{key:"isDataChannelReady",value:function(){return!!this.receiveChannel&&!!this.dataChannel}},{key:"communicate",value:function(e){if(!this.isDataChannelReady())throw new Error("DC is not available now");this.dataChannel.send(e)}},{key:"grabScreen",value:function(){if(navigator.mediaDevices.getUserMedia)return navigator.mediaDevices.getDisplayMedia({video:!0}).then(this.getUserMediaSuccess).catch(this.errorHandler);alert("Your browser does not support getDisplayMedia API")}},{key:"createUUID",value:function(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}}]),t}(b.EventEmitter),O=function(e){function t(e){var n;return Object(s.a)(this,t),(n=Object(u.a)(this,Object(m.a)(t).call(this))).connected=!1,n.filterFn=void 0,n.wrapFn=void 0,n.sendFn=void 0,n.filterFn=function(e){try{var t=JSON.parse(e);if(t.preoccupy)return t.preoccupy}catch(n){return null}return null},n.wrapFn=function(e){return{preoccupy:e.serialize()}},n.sendFn=e.send,n}return Object(d.a)(t,e),Object(l.a)(t,[{key:"disconnect",value:function(){this.off(),this.connected=!1}},{key:"publish",value:function(e){var t=new g.c("action",e);this.sendFn(this.wrapFn(t))}},{key:"onMessage",value:function(e){var t=this.filterFn(e);if(t){var n=g.c.parse("|||"+t);console.log(t,n),this.trigger(g.d.action,n)}}},{key:"handshake",value:function(){this.connected?this.trigger(g.d.connect):this.connect()}},{key:"connect",value:function(){this.trigger(g.d.connect,null)}}]),t}(g.a),k=function(e){function t(e){var n;return Object(s.a)(this,t),(n=Object(u.a)(this,Object(m.a)(t).call(this,e))).ws=new w,n.webRtc=new E(n.ws),n.preoccupyTransport=null,n.toNameRef=r.a.createRef(),n.toMessageRef=r.a.createRef(),n.handleOnStartCallClick=function(){var e=n.toNameRef.current&&n.toNameRef.current.value;e&&n.webRtc.grabScreen().then(function(){n.webRtc.start(e)})},n.handleOnSendMessageClick=function(){var e=n.toNameRef.current&&n.toNameRef.current.value,t=n.toMessageRef.current&&n.toMessageRef.current.value;e&&t&&(n.webRtc.dataChannel?n.webRtc.communicate(t):n.ws.communicate(e,t))},n.initPreoccupyjsHost=function(){var e=n.webRtc,t=new O({send:function(t){return e.communicate(JSON.stringify(t))}});new g.b(t,document.getElementById("pad")).start(),n.preoccupyTransport=t},n.initPreoccupyjsClient=function(){var e=n.webRtc,t=new O({send:function(t){return e.communicate(JSON.stringify(t))}});Object(g.e)(document.body,t).start(),n.preoccupyTransport=t},n.state={name:null,messages:[]},n}return Object(d.a)(t,e),Object(l.a)(t,[{key:"render",value:function(){var e=this;return r.a.createElement(h.a,null,r.a.createElement(f.a,null,r.a.createElement(p.a,null,r.a.createElement(y,{idAttr:"localVideo"})),r.a.createElement(p.a,null,r.a.createElement("div",{className:"remoteVideoScree"},r.a.createElement(y,{idAttr:"remoteVideo"}),r.a.createElement("div",{id:"pad",className:"pad"})))),r.a.createElement(f.a,null,r.a.createElement(p.a,null,r.a.createElement(v.a,{onClick:function(){return e.handleOnRegisterClick()},variant:"primary"},"Register")),r.a.createElement(p.a,null,r.a.createElement(v.a,{onClick:this.handleOnStartCallClick,variant:"success"},"Call"),r.a.createElement(v.a,{variant:"danger"},"Abort call")),r.a.createElement(p.a,null,"Logged in as: ",this.state.name)),r.a.createElement(f.a,null,r.a.createElement(p.a,null),r.a.createElement(p.a,null,r.a.createElement(v.a,{onClick:this.initPreoccupyjsHost},"Init Host"),r.a.createElement(v.a,{onClick:this.initPreoccupyjsClient},"Init Clinet")),r.a.createElement(p.a,null)),r.a.createElement(f.a,null,r.a.createElement(p.a,null,r.a.createElement("input",{ref:this.toNameRef,placeholder:"Message to...",type:"text"}),r.a.createElement("textarea",{ref:this.toMessageRef,placeholder:"Message body..."})),r.a.createElement(p.a,null,r.a.createElement(v.a,{onClick:this.handleOnSendMessageClick,variant:"secondary"},"Send message")),r.a.createElement(p.a,null,"Messages: ",this.state.messages.map(function(e,t){return r.a.createElement("div",{key:t},r.a.createElement(C,{item:e}),r.a.createElement("hr",null))}))))}},{key:"componentDidMount",value:function(){var e=this;this.ws.connect(),this.ws.on("register",function(t){var n=t.result,a=t.name;e.setState({name:n&&a?a:null})}),this.ws.on("communticate",function(t){e.setState({messages:[].concat(Object(o.a)(e.state.messages),[t])})}),this.webRtc.on("communticate",function(t){e.preoccupyTransport&&e.preoccupyTransport.onMessage(t.message),e.setState({messages:[].concat(Object(o.a)(e.state.messages),[t])})}),this.initWebRTC()}},{key:"handleOnRegisterClick",value:function(){var e=prompt("Enter a name");e&&this.ws.register(e)}},{key:"initWebRTC",value:function(){this.webRtc.init("localVideo","remoteVideo")}}]),t}(r.a.Component);i.a.render(r.a.createElement(k,null),document.getElementById("root"))}},[[18,1,2]]]);
//# sourceMappingURL=main.aebbe3e9.chunk.js.map